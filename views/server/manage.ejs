<!DOCTYPE html>
<html lang="en" class="bg-neutral-950 text-gray-100 font-Figtree">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= name %> - <%= server.name %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    #logContainer {
      scroll-behavior: smooth;
      font-family: Figtree, monospace;
    }
  </style>
</head>
<body class="min-h-screen flex">

  <!-- Sidebar -->
  <%- include('../components/sidebar', { name: name, user: user }) %>

  <main class="flex-1 p-8 overflow-auto">
    <div class="max-w-6xl mx-auto space-y-6">

      <!-- Server Header -->
      <div class="bg-neutral-950 border border-neutral-900 p-6 rounded-2xl shadow-lg flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold">ðŸ–¥ <%= server.name %></h1>
          <p class="text-gray-400 mt-1">Node: <%= server.node?.name || 'Unknown' %> | IP: <%= server.node?.ip || '0.0.0.0' %>:<%= server.port %></p>
        </div>
        <div>
          <% if (server.status === "online") { %>
            <span class="flex items-center gap-2 text-green-400">
              <i data-lucide="heart-pulse" class="w-5 h-5 animate-pulse"></i> Online
            </span>
          <% } else { %>
            <span class="flex items-center gap-2 text-red-400">
              <i data-lucide="x-circle" class="w-5 h-5"></i> Offline
            </span>
          <% } %>
        </div>
      </div>

      <%- include('../components/server_nav', { server: server.id }) %>

      <!-- Custom Terminal -->
      <div id="terminal" class="bg-[#080808] border border-[#d4d4d4]/20 rounded-2xl h-96 flex flex-col">
        <div id="logContainer" class="flex-1 overflow-y-auto p-4 text-[#d4d4d4] text-sm space-y-1"></div>
        <div class="p-4 border-t border-[#d4d4d4]/20 flex gap-2">
          <input id="cmdInput" type="text" placeholder="Type a command..."
            class="flex-1 bg-[#080808] border border-[#d4d4d4]/20 rounded px-3 py-2 text-[#d4d4d4] font-mono focus:outline-none focus:ring-2 focus:ring-[#d4d4d4]/50" />
          <button id="sendBtn"
            class="bg-[#d4d4d4]/20 text-[#080808] px-4 py-2 rounded font-semibold hover:bg-[#d4d4d4]/30 transition active:scale-95">
            Send
          </button>
        </div>
      </div>

    </div>
  </main>
<script>
const logContainer = document.getElementById('logContainer');

const logColors = {
  INFO: '#d4d4d4',
  WARN: '#f59e0b',
  ERROR: '#ef4444',
  SYSTEM: '#10b981',
  POWER: '#fbbf24',
  COMMAND: '#3b82f6',
  DAEMON: '#8b5cf6'
};

function hexToAlpha(hex, alpha) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function stripAnsiCodes(str) {
  return str.replace(/\x1b\[[0-9;]*m/g, '');
}

function parseServerMessage(msg) {
  // 1. Remove all ANSI sequences (colors, cursor moves, etc.)
  msg = msg.replace(/\x1b\[[0-9;?]*[a-zA-Z]/g, '');

  // 2. Remove all leading clutter like >...., =>...., =>.... or combinations
  msg = msg.replace(/^[\x1b>=\.]+ ?/g, '').trim();

  // 3. Match [HH:MM:SS TYPE]: message
  const timestampRegex = /^\[(\d{2}:\d{2}:\d{2}) (\w+)\]:\s*(.*)$/;
  const tsMatch = msg.match(timestampRegex);
  if (tsMatch) {
    return { type: tsMatch[2].toUpperCase(), text: tsMatch[3] };
  }

  // 4. Lines starting with type directly
  const typeRegex = /^(\w+)\s+(.*)$/;
  const typeMatch = msg.match(typeRegex);
  if(typeMatch && ['INFO','WARN','ERROR','SYSTEM','DAEMON','COMMAND','POWER'].includes(typeMatch[1].toUpperCase())) {
    return { type: typeMatch[1].toUpperCase(), text: typeMatch[2] };
  }

  // 5. Fallback to INFO
  return { type: 'INFO', text: msg };
}


function addLog(type, message) {
  const logLine = document.createElement('div');
  logLine.classList.add('flex', 'items-center', 'gap-2');

  const badge = document.createElement('span');
  badge.textContent = type;
  badge.classList.add('inline-flex', 'px-2', 'py-0.5', 'text-xs', 'font-semibold', 'uppercase', 'rounded');
  badge.style.backgroundColor = hexToAlpha(logColors[type] || '#d4d4d4', 0.1);
  badge.style.color = logColors[type] || '#d4d4d4';

  const text = document.createElement('span');
  text.textContent = message;

  logLine.appendChild(badge);
  logLine.appendChild(text);
  logContainer.appendChild(logLine);

  logContainer.scrollTop = logContainer.scrollHeight;
}

const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${protocol}://${window.location.hostname}${window.location.port ? ':'+window.location.port : ''}/console/<%= server.id %>`);

ws.onopen = () => addLog('DAEMON', 'Connected to server console');
ws.onmessage = (evt) => {
  try {
    const data = JSON.parse(evt.data);
    if(data.event === 'cmd' || data.event === 'error') {
      const parsed = parseServerMessage(data.payload);
      addLog(parsed.type, parsed.text);
    } else if(data.event.startsWith('power')) {
      addLog('POWER', data.payload);
    } else {
      addLog('SYSTEM', data.payload);
    }
  } catch {
    const parsed = parseServerMessage(evt.data);
    addLog(parsed.type, parsed.text);
  }
};
ws.onclose = () => addLog('DAEMON', 'Disconnected from server');
ws.onerror = () => addLog('ERROR', 'WebSocket error');

document.getElementById('sendBtn').addEventListener('click', () => {
  const input = document.getElementById('cmdInput');
  const cmd = input.value.trim();
  if(!cmd || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({ event: 'cmd', payload: { containerId: "<%= server.containerId %>", command: cmd } }));
  addLog('COMMAND', cmd);
  input.value = '';
});

document.getElementById('cmdInput').addEventListener('keydown', (e) => {
  if(e.key === 'Enter') document.getElementById('sendBtn').click();
});

// Hook power buttons to your existing WebSocket
  document.querySelectorAll('#power-actions button[data-action]').forEach(btn => {
    btn.addEventListener('click', () => {
      const action = btn.getAttribute('data-action');
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          event: `power:${action}`,
          payload: { containerId: "<%= server.containerId %>" }
        }));
        addLog('POWER', `Sent power:${action}`);
      } else {
        addLog('ERROR', 'WebSocket not connected. Cannot send power command.');
      }
    });
  });
</script>


</body>
</html>

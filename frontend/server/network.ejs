<!DOCTYPE html>
<html lang="en" class="h-full bg-black text-white font-space-grotesk antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= name %> - <%= server.name %> Network
  </title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    .font-space-grotesk {
      font-family: 'Space Grotesk', sans-serif;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #000;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }
  </style>
</head>

<body class="flex h-full w-full overflow-hidden">

  <%- include('../components/sidebar', { name: name, user: user }) %>

    <main class="relative flex-1 overflow-y-auto bg-black">
      <div class="mx-auto max-w-5xl px-6 py-12 md:px-12">

        <!-- Header -->
        <div class="mb-12">
          <h1 class="text-3xl font-bold tracking-tight text-white md:text-4xl">Network Management</h1>
          <p class="mt-2 text-neutral-400">Configure ports and allocations for your server.</p>
        </div>
<% if (req.query.error === 'cant_add_more') { %>
  <div class="mb-6 flex items-center gap-3 rounded-xl border border-red-900/50 bg-red-950/20 px-4 py-3 text-sm text-red-200">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
      stroke="currentColor" class="h-5 w-5 text-red-500">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
    </svg>
    Youâ€™ve reached the maximum number of allocations. Delete one to add a new port.
  </div>
<% } %>

<% if (req.query.error === 'no_ports_available') { %>
  <div class="mb-6 flex items-center gap-3 rounded-xl border border-red-900/50 bg-red-950/20 px-4 py-3 text-sm text-red-200">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
      stroke="currentColor" class="h-5 w-5 text-red-500">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
    </svg>
    No free ports are available on this node right now.
  </div>
<% } %>
<% if (req.query.error === 'failed') { %>
  <div class="mb-6 flex items-center gap-3 rounded-xl border border-red-900/50 bg-red-950/20 px-4 py-3 text-sm text-red-200">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
      stroke="currentColor" class="h-5 w-5 text-red-500">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
    </svg>
    Failed to add an allocation, please contact an administrator
  </div>
<% } %>
<% if (req.query.allocation === 'primary_exists') { %>
  <div class="mb-6 flex items-center gap-3 rounded-xl border border-red-900/50 bg-red-950/20 px-4 py-3 text-sm text-red-200">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
      stroke="currentColor" class="h-5 w-5 text-red-500">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
    </svg>
    This server already has a primary allocation.
  </div>
<% } %>

<% if (req.query.allocation === 'claimed') { %>
  <div class="mb-6 flex items-center gap-3 rounded-xl border border-green-900/50 bg-green-950/20 px-4 py-3 text-sm text-green-200">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
      stroke="currentColor" class="h-5 w-5 text-green-500">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M5 13l4 4L19 7" />
    </svg>
    Allocation successfully claimed!
  </div>
<% } %>
<% if (req.query.allocation === 'released') { %>
  <div class="mb-6 flex items-center gap-3 rounded-xl border border-green-900/50 bg-green-950/20 px-4 py-3 text-sm text-green-200">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
      stroke="currentColor" class="h-5 w-5 text-green-500">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M5 13l4 4L19 7" />
    </svg>
    Allocation successfully released!
  </div>
<% } %>
<% if (req.query.allocation === 'primary') { %>
  <div class="mb-6 flex items-center gap-3 rounded-xl border border-green-900/50 bg-green-950/20 px-4 py-3 text-sm text-green-200">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
      stroke="currentColor" class="h-5 w-5 text-green-500">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M5 13l4 4L19 7" />
    </svg>
   Primary updated!
  </div>
<% } %>
        <!-- Allocations List -->
        <div class="mb-8 rounded-2xl border border-neutral-900 bg-neutral-950 p-6">
          <div class="mb-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <h2 class="text-lg font-bold text-white">
              Assigned Allocations
            </h2>

            <span class="text-sm font-medium text-neutral-400">
              Allowed:
              <span class="font-mono text-white">
                <%= server.allocationLimit - allocations.length %>
              </span>
            </span>
          </div>


          <div class="space-y-4">
            <% if (!allocations || allocations.length===0) { %>
              <div
                class="rounded-xl border border-dashed border-neutral-800 bg-neutral-900/30 p-8 text-center text-neutral-500">
                No allocations found.
              </div>
              <% } else { %>
                <% allocations.forEach(a=> { %>
                  <div
                    class="flex items-center justify-between rounded-xl border border-neutral-900 bg-neutral-900/30 p-4 transition-colors hover:border-neutral-800">

                    <div class="flex items-center gap-6">
                      <div
                        class="flex h-12 w-12 items-center justify-center rounded-xl bg-neutral-800 text-neutral-300">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                          stroke="currentColor" class="h-6 w-6">
                          <path stroke-linecap="round" stroke-linejoin="round"
                            d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6.75v10.5a2.25 2.25 0 002.25 2.25z" />
                        </svg>
                      </div>
                      <div>
                        <div class="flex items-center gap-3">
                          <span class="font-mono text-lg font-bold text-white">
                            <%= a.port %>
                          </span>
                          <% if (a.type==='primary' ) { %>
                            <span
                              class="rounded-full bg-emerald-900/20 px-2 py-0.5 text-xs font-bold text-emerald-500 border border-emerald-900/30">Primary</span>
                            <% } else { %>
                              <span
                                class="rounded-full bg-neutral-800 px-2 py-0.5 text-xs font-bold text-neutral-400">Secondary</span>
                              <% } %>
                        </div>
                        <p class="text-xs text-neutral-500 my-1">
                          <%= server.node?.name || server.node?.ip || 'Unknown Node' %>
                        </p>
                        <p class="text-xs text-neutral-600 font-mono">
                          <%= server.ip || '0.0.0.0' %>:<%= a.port %>
                        </p>
                      </div>
                    </div>

                    <div class="flex gap-2">
                      <% if (a.type !=='primary' ) { %>
                        <form method="POST" action="/server/network/<%= server.id %>/setprimary/<%= a.port %>">
                          <button
                            class="rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-xs font-bold text-white hover:bg-neutral-800 transition-colors">
                            Make Primary
                          </button>
                        </form>
                        <form method="POST" action="/server/network/<%= server.id %>/remove/<%= a.port %>">
                          <button
                            class="rounded-lg border border-red-900/30 bg-red-900/10 px-3 py-2 text-xs font-bold text-red-500 hover:bg-red-900/20 transition-colors">
                            Remove
                          </button>
                        </form>
                        <% } else { %>
                          <span class="text-xs italic text-neutral-600 mr-2">Primary allocation cannot be deleted</span>
                          <% } %>
                    </div>

                  </div>
                  <% }) %>
                    <% } %>
          </div>
        </div>

        <!-- Add Allocation -->
        <div class="rounded-2xl border border-neutral-900 bg-neutral-950 p-6">
          <h2 class="mb-4 text-lg font-bold text-white">Add Port</h2>
          <p class="mb-6 text-sm text-neutral-500">
            A random available port will be automatically assigned to this server.
            A restart may be required for changes to take effect.
          </p>

          <form method="GET" action="/server/network/<%= server.id %>/add">
            <button type="submit"
              class="rounded-lg bg-white px-5 py-2.5 text-sm font-bold text-black transition-transform active:scale-95 hover:bg-neutral-200">
              Add Random Port
            </button>
          </form>
        </div>


      </div>
    </main>

    <script>
      function addPort() {
        const port = document.getElementById('new-port').value;
        if (!port) return;
        // Using existing logic (GET request triggers backend logic presumably, based on old code)
        // Ideally this should be POST but following old pattern for compatibility if backend expects GET
        window.location.href = `/server/network/<%= server.id %>/add/${port}`;
      }
    </script>

</body>

</html>
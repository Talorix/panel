<!DOCTYPE html>
<html lang="en" class="h-full bg-neutral-950 text-gray-100 font-space-grotesk antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= name %> - <%= server.name %> Network</title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    .font-space-grotesk {
      font-family: 'Space Grotesk', sans-serif;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #0b0b0b;
    }

    ::-webkit-scrollbar-thumb {
      background: #2b2b2b;
      border-radius: 3px;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slide-down {
      animation: slideDown 0.3s ease-out;
    }

    .allocation-card {
      transition: all 0.2s ease;
    }

    .allocation-card:hover {
      background-color: rgba(23, 23, 23, 0.5);
      border-color: rgb(38, 38, 38);
    }
  </style>
</head>

<body class="flex h-full w-full overflow-hidden">

  <%- include('../components/sidebar', { name: name, user: user }) %>

  <main class="relative flex-1 overflow-y-auto bg-black">
    <div class="mx-auto max-w-5xl px-6 py-12 md:px-12">

      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold tracking-tight text-gray-100 md:text-4xl">Network Management</h1>
        <p class="mt-2 text-sm text-neutral-400">
          Configure ports and allocations for 
          <span class="font-medium text-neutral-300"><%= server.name %></span>
        </p>
      </div>

      <!-- Error Messages -->
      <% if (req.query.error === 'cant_add_more') { %>
        <div class="mb-6 animate-slide-down flex items-center gap-3 rounded-md border border-red-900/50 bg-red-950/20 px-4 py-3 text-sm text-red-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-5 w-5 flex-shrink-0 text-red-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
          You've reached the maximum number of allocations. Delete one to add a new port.
        </div>
      <% } %>

      <% if (req.query.error === 'no_ports_available') { %>
        <div class="mb-6 animate-slide-down flex items-center gap-3 rounded-md border border-red-900/50 bg-red-950/20 px-4 py-3 text-sm text-red-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-5 w-5 flex-shrink-0 text-red-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
          No free ports are available on this node right now.
        </div>
      <% } %>

      <% if (req.query.error === 'failed') { %>
        <div class="mb-6 animate-slide-down flex items-center gap-3 rounded-md border border-red-900/50 bg-red-950/20 px-4 py-3 text-sm text-red-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-5 w-5 flex-shrink-0 text-red-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
          Failed to add an allocation, please contact an administrator
        </div>
      <% } %>

      <% if (req.query.allocation === 'primary_exists') { %>
        <div class="mb-6 animate-slide-down flex items-center gap-3 rounded-md border border-red-900/50 bg-red-950/20 px-4 py-3 text-sm text-red-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-5 w-5 flex-shrink-0 text-red-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
          This server already has a primary allocation.
        </div>
      <% } %>

      <!-- Success Messages -->
      <% if (req.query.allocation === 'claimed') { %>
        <div class="mb-6 animate-slide-down flex items-center gap-3 rounded-md border border-green-900/50 bg-green-950/20 px-4 py-3 text-sm text-green-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-5 w-5 flex-shrink-0 text-green-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Allocation successfully claimed!
        </div>
      <% } %>

      <% if (req.query.allocation === 'released') { %>
        <div class="mb-6 animate-slide-down flex items-center gap-3 rounded-md border border-green-900/50 bg-green-950/20 px-4 py-3 text-sm text-green-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-5 w-5 flex-shrink-0 text-green-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Allocation successfully released!
        </div>
      <% } %>

      <% if (req.query.allocation === 'primary') { %>
        <div class="mb-6 animate-slide-down flex items-center gap-3 rounded-md border border-green-900/50 bg-green-950/20 px-4 py-3 text-sm text-green-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-5 w-5 flex-shrink-0 text-green-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Primary updated!
        </div>
      <% } %>

      <!-- Allocations List -->
      <div class="mb-8 rounded-md border border-neutral-800 bg-neutral-950 overflow-hidden">
        <div class="border-b border-neutral-800 px-6 py-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <h2 class="text-lg font-bold text-gray-100">
            Assigned Allocations
          </h2>
          <div class="flex items-center gap-2">
            <span class="text-sm text-neutral-400">Remaining:</span>
            <span class="inline-flex items-center gap-1.5 rounded-md bg-neutral-800 px-2.5 py-1 text-sm font-semibold text-gray-100">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <%= server.allocationLimit - allocations.length %>
            </span>
          </div>
        </div>

        <div class="p-6">
          <% if (!allocations || allocations.length === 0) { %>
            <div class="flex flex-col items-center justify-center rounded-md border border-dashed border-neutral-800 bg-neutral-900/30 p-12 text-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-neutral-700 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6.75v10.5a2.25 2.25 0 002.25 2.25z" />
              </svg>
              <h3 class="text-base font-medium text-neutral-400">No allocations found</h3>
              <p class="mt-1 text-sm text-neutral-600">Add a port to get started</p>
            </div>
          <% } else { %>
            <div class="space-y-3">
              <% allocations.forEach((a, idx) => { %>
                <div class="allocation-card flex items-center justify-between rounded-md border border-neutral-800 bg-neutral-900/30 p-4" style="animation-delay: <%= idx * 30 %>ms;">
                  
                  <div class="flex items-center gap-4">
                    <div class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-md bg-neutral-800 text-neutral-400">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6.75v10.5a2.25 2.25 0 002.25 2.25z" />
                      </svg>
                    </div>
                    
                    <div>
                      <div class="flex items-center gap-2.5">
                        <span class="font-mono text-lg font-bold text-gray-100">
                          <%= a.port %>
                        </span>
                        <% if (a.type === 'primary') { %>
                          <span class="inline-flex items-center gap-1 rounded-md bg-emerald-950/50 px-2 py-0.5 text-xs font-semibold text-emerald-400 border border-emerald-900/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                            Primary
                          </span>
                        <% } else { %>
                          <span class="rounded-md bg-neutral-800 px-2 py-0.5 text-xs font-semibold text-neutral-400">
                            Secondary
                          </span>
                        <% } %>
                      </div>
                      <p class="mt-1 text-xs text-neutral-500">
                        <%= server.node?.name || server.node?.ip || 'Unknown Node' %>
                      </p>
                      <p class="mt-0.5 text-xs font-mono text-neutral-600">
                        <%= server.ip || '0.0.0.0' %>:<%= a.port %>
                      </p>
                    </div>
                  </div>

                  <div class="flex items-center gap-2">
                    <% if (a.type !== 'primary') { %>
                      <form method="POST" action="/server/network/<%= server.id %>/setprimary/<%= a.port %>">
                        <button type="submit" class="rounded-md border border-neutral-800 bg-neutral-900 px-3 py-1.5 text-xs font-semibold text-gray-100 transition-colors hover:border-neutral-700 hover:bg-neutral-800">
                          Make Primary
                        </button>
                      </form>
                      <form method="POST" action="/server/network/<%= server.id %>/remove/<%= a.port %>">
                        <button type="submit" class="rounded-md bg-red-600/90 px-3 py-1.5 text-xs font-semibold text-white transition-colors hover:bg-red-600">
                          Remove
                        </button>
                      </form>
                    <% } else { %>
                      <span class="text-xs italic text-neutral-600">Primary allocation cannot be deleted</span>
                    <% } %>
                  </div>

                </div>
              <% }) %>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Add Allocation -->
      <div class="rounded-md border border-neutral-800 bg-neutral-950 overflow-hidden">
        <div class="border-b border-neutral-800 px-6 py-4">
          <h2 class="text-lg font-bold text-gray-100">Add Port</h2>
        </div>
        <div class="p-6">
          <p class="mb-6 text-sm text-neutral-400">
            A random available port will be automatically assigned to this server. A restart may be required for changes to take effect.
          </p>

          <form method="GET" action="/server/network/<%= server.id %>/add">
            <button type="submit" class="inline-flex items-center gap-2 rounded-md border border-neutral-800 bg-neutral-900 px-4 py-2.5 text-sm font-semibold text-gray-100 transition-all hover:border-neutral-700 hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-700 focus:ring-offset-2 focus:ring-offset-neutral-950">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
              </svg>
              Add Random Port
            </button>
          </form>
        </div>
      </div>

    </div>
  </main>

</body>

</html>
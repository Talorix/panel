<!DOCTYPE html>
<html lang="en" class="h-full bg-neutral-950 text-gray-100 font-space-grotesk antialiased">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= name %> - <%= server.name %> Archives</title>
    <link rel="stylesheet" href="/assets/tailwind.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

        .font-space-grotesk {
            font-family: 'Space Grotesk', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0b0b0b;
        }

        ::-webkit-scrollbar-thumb {
            background: #2b2b2b;
            border-radius: 3px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .animate-slide-down {
            animation: slideDown 0.3s ease-out;
        }

        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .archive-row {
            transition: background-color 0.2s ease;
        }

        .archive-row:hover {
            background-color: rgba(23, 23, 23, 0.5);
        }
    </style>
</head>

<body class="flex h-full w-full overflow-hidden">

    <%- include('../components/sidebar', { name: name, user: user }) %>

    <main class="relative flex-1 overflow-y-auto bg-black">
        <div class="mx-auto max-w-5xl px-6 py-12 md:px-12">
            <!-- Header -->
            <div class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight text-gray-100 md:text-4xl">
                        Archives
                    </h1>
                    <p class="mt-2 text-sm text-neutral-400">
                        Backups and archives for 
                        <span class="font-medium text-neutral-300"><%= server.name %></span>
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    <button 
                        onclick="createarchive()" 
                        id="createBtn"
                        class="group inline-flex items-center gap-2 rounded-md border border-neutral-800 bg-neutral-900 px-4 py-2.5 text-sm font-semibold text-gray-100 transition-all hover:border-neutral-700 hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-700 focus:ring-offset-2 focus:ring-offset-neutral-950 disabled:cursor-not-allowed disabled:opacity-50"
                        aria-haspopup="dialog">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform group-hover:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                        <span id="createBtnText">Create Archive</span>
                    </button>
                </div>
            </div>

            <!-- Success Message -->
            <% if (req.query.success) { %>
            <div class="mb-6 animate-slide-down flex items-center gap-3 rounded-md border border-green-900/50 bg-green-950/20 px-4 py-3 text-sm text-green-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-5 w-5 flex-shrink-0 text-green-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Successfully completed the action!
            </div>
            <% } %>

            <!-- Archive list panel -->
            <section class="rounded-md border border-neutral-800 bg-neutral-950 overflow-hidden">
                <div class="border-b border-neutral-800 px-6 py-4">
                    <h2 class="text-lg font-bold text-gray-100">Available Archives</h2>
                    <% if (archives && archives.length > 0) { %>
                    <p class="mt-1 text-xs text-neutral-500"><%= archives.length %> archive<%= archives.length === 1 ? '' : 's' %> found</p>
                    <% } %>
                </div>

                <% if (!archives || archives.length === 0) { %>
                <div class="px-6 py-12">
                    <div class="flex flex-col items-center justify-center rounded-md border border-dashed border-neutral-800 bg-neutral-900/30 p-12 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-neutral-700 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                        <h3 class="text-base font-medium text-neutral-400">No archives found</h3>
                        <p class="mt-1 text-sm text-neutral-600">Create your first archive to get started</p>
                    </div>
                </div>
                <% } else { %>

                <div class="overflow-x-auto">
                    <table class="w-full min-w-[640px] table-auto">
                        <thead>
                            <tr class="border-b border-neutral-800 text-left text-xs font-medium uppercase tracking-wider text-neutral-500">
                                <th class="py-3 px-6">Name</th>
                                <th class="py-3 px-6">Size</th>
                                <th class="py-3 px-6">Created</th>
                                <th class="py-3 px-6 text-right">Actions</th>
                            </tr>
                        </thead>

                        <tbody class="divide-y divide-neutral-900">
                            <% archives.forEach((a, idx) => { %>
                            <tr class="archive-row" style="animation-delay: <%= idx * 50 %>ms;">
                                <td class="py-4 px-6 align-top">
                                    <div class="flex items-start gap-3">
                                        <div class="flex-shrink-0 mt-0.5">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                            </svg>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div class="max-w-md overflow-hidden text-ellipsis whitespace-nowrap text-sm font-medium text-gray-100" title="<%= a.name %>">
                                                <%= a.name %>
                                            </div>
                                            <% if (a.path) { %>
                                            <div class="mt-1 text-xs font-mono text-neutral-600">
                                                <%= a.path.replace(/^.*[\\/]/, '') %>
                                            </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </td>

                                <td class="py-4 px-6 align-top text-sm text-neutral-400">
                                    <%= a.sizeHuman || (a.size ? (a.size + ' bytes') : '-') %>
                                </td>

                                <td class="py-4 px-6 align-top text-sm text-neutral-400 whitespace-nowrap">
                                    <%= new Date(a.createdAt).toLocaleString() %>
                                </td>

                                <td class="py-4 px-6 align-top text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <!-- Extract form -->
                                        <form action="/server/archive/<%= server.id %>/extract" method="POST" class="inline">
                                            <input type="hidden" name="archiveName" value="<%= a.name %>" />
                                            <button 
                                                type="submit"
                                                class="inline-flex items-center gap-1.5 rounded-md border border-neutral-800 bg-neutral-900 px-3 py-1.5 text-xs font-semibold text-gray-100 transition-colors hover:border-neutral-700 hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-700 focus:ring-offset-2 focus:ring-offset-neutral-950"
                                                aria-label="Extract <%= a.name %>">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                                </svg>
                                                Extract
                                            </button>
                                        </form>

                                        <!-- Delete button -->
                                        <button 
                                            type="button"
                                            onclick="confirmDelete('<%= encodeURIComponent(a.name) %>', '<%= a.name %>')"
                                            class="inline-flex items-center gap-1.5 rounded-md bg-red-600/90 px-3 py-1.5 text-xs font-semibold text-white transition-colors hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-neutral-950"
                                            aria-label="Delete <%= a.name %>">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>

                <% } %>
            </section>

        </div>
    </main>

    <!-- Scripts -->
    <script>
        async function confirmDelete(encodedName, prettyName) {
            const displayName = prettyName || decodeURIComponent(encodedName);

            if (!confirm(`Delete archive "${displayName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const resp = await fetch(`/server/archive/<%= server.id %>?archiveName=${encodedName}`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!resp.ok) {
                    const body = await resp.json().catch(() => ({}));
                    alert('Failed to delete archive: ' + (body.error || resp.statusText));
                    return;
                }

                window.location.reload();
            } catch (err) {
                console.error('Delete failed', err);
                alert('Failed to delete archive. See console for details.');
            }
        }

        async function createarchive() {
            const createBtn = document.getElementById("createBtn");
            const createBtnText = document.getElementById("createBtnText");
            
            createBtn.disabled = true;
            createBtn.classList.add("opacity-50", "cursor-not-allowed");
            createBtnText.innerHTML = '<span class="animate-pulse-slow">Creating...</span>';
            
            try {
                const resp = await fetch(`/server/archive/<%= server.id %>/create`, {
                    method: 'POST'
                });
                
                if (!resp.ok) {
                    throw new Error('Archive creation failed');
                }
                
                window.location.reload();
            } catch (err) {
                console.error('Creation failed', err);
                alert('Failed to create archive. See console for details.');
                createBtn.disabled = false;
                createBtn.classList.remove("opacity-50", "cursor-not-allowed");
                createBtnText.textContent = "Create Archive";
            }
        }
    </script>
</body>

</html>
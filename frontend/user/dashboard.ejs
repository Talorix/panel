<!DOCTYPE html>
<html lang="en" class="h-full bg-black text-white font-space-grotesk antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= name %> - Dashboard
  </title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <link rel="icon" type="image/x-icon" href="<%= config.logo %>">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    .font-space-grotesk {
      font-family: 'Space Grotesk', sans-serif;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #000;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }
  </style>
</head>

<body class="flex h-full w-full overflow-hidden">

  <!-- Sidebar -->
  <%- include('../components/sidebar', { name: name, user: user }) %>

    <!-- Main Content -->
    <main class="relative flex-1 overflow-y-auto bg-black">
      <div class="mx-auto max-w-7xl px-6 py-12 md:px-12 animate-fade-in-up">

        <!-- Welcome Header -->
        <div class="mb-12 flex flex-col justify-between gap-6 md:flex-row md:items-end">
          <div>
            <h1 class="text-3xl font-bold tracking-tight text-white md:text-4xl">Dashboard</h1>
            <p class="mt-2 text-neutral-400">Overview of your deployed infrastructure.</p>
          </div>

          <!-- Quick Actions / Filter (Optional) -->
          <div class="flex items-center gap-2">
            <% if (user.admin) { %>
              <a href="<%= req.query.admin === 'true' ? '/dashboard' : '/dashboard?admin=true' %>"
                class="flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-neutral-800 active:scale-95 duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="w-5 h-5 text-neutral-400">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                </svg>
                <%= req.query.admin==='true' ? 'View My Servers' : 'View All Servers' %>
              </a>
              <% } %>
          </div>
        </div>


        <!-- Servers Table -->
        <div class="overflow-hidden rounded-2xl border border-neutral-900 bg-neutral-950 shadow-2xl">
          <table class="w-full text-left text-sm">
            <thead class="border-b border-neutral-900 bg-neutral-900/50 text-neutral-400">
              <tr>
                <th class="px-6 py-4 font-medium">Server</th>
                <th class="px-6 py-4 font-medium">Status</th>
                <th class="px-6 py-4 font-medium">Node</th>
                <th class="px-6 py-4 font-medium">Uptime</th>
                <th class="px-6 py-4 text-right font-medium">Actions</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-neutral-900" id="serversTableBody">
              <% if (servers && servers.length> 0) { %>
                <% servers.forEach((server, index)=> { %>
                  <tr class="group hover:bg-neutral-900/40 transition-colors animate-fade-in-up"
                    style="animation-delay: <%= Math.min(index * 50, 500) %>ms;">

                    <!-- Server -->
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-4">
                        <div
                          class="flex h-10 w-10 items-center justify-center rounded-lg bg-neutral-900 text-neutral-400 group-hover:bg-white group-hover:text-black transition-all">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                            <rect width="20" height="8" x="2" y="2" rx="2" ry="2" />
                            <rect width="20" height="8" x="2" y="14" rx="2" ry="2" />
                            <line x1="6" x2="6.01" y1="6" y2="6" />
                            <line x1="6" x2="6.01" y1="18" y2="18" />
                          </svg>
                        </div>

                        <div>
                          <div class="font-bold text-white">
                            <%= server.name %>
                          </div>
                          <div class="font-mono text-xs text-neutral-500">
                            <%= server.id.substring(0, 8) %>...
                          </div>
                        </div>
                      </div>
                    </td>

                    <!-- Status -->
                    <td class="px-6 py-4">
                      <% if (server.suspended) { %>
                        <span
                          class="inline-flex items-center gap-1.5 rounded-full bg-red-500/10 px-2.5 py-1 text-xs font-bold text-red-500 border border-red-500/20 animate-pulse">
                          Suspended
                        </span>
                        <% } else { %>
                          <div class="flex items-center gap-2">
                            <div id="status-dot-<%= server.id %>" class="h-2.5 w-2.5 rounded-full bg-neutral-700"></div>
                            <span id="status-text-<%= server.id %>" class="text-xs text-neutral-400">
                              Checking
                            </span>
                          </div>
                          <% } %>
                    </td>

                    <!-- Node -->
                    <td class="px-6 py-4">
                      <div>
                        <div class="text-sm font-medium text-white">
                          <%= server.node?.name || 'Unknown' %>
                        </div>
                        <div class="font-mono text-xs text-neutral-500">
                          <%= server.node?.ip %>:<%= server.port %>
                        </div>
                      </div>
                    </td>

                    <!-- Uptime -->
                    <td class="px-6 py-4">
                      <span id="uptime-<%= server.id %>" class="font-mono text-xs text-neutral-300">
                        <% if (server.suspended) { %>Suspended<% } else { %>--:--:--<% } %>
                      </span>
                    </td>

                    <!-- Actions -->
                    <td class="px-6 py-4 text-right">
                      <% if (!server.suspended) { %>
                        <a href="/server/manage/<%= server.id %>"
                          class="inline-flex items-center justify-center rounded-lg bg-neutral-900 border border-neutral-800 px-4 py-2 text-xs font-bold text-neutral-300 hover:bg-neutral-800 hover:text-white transition active:scale-95">
                          Manage
                        </a>
                        <% } else { %>
                          <span class="text-xs text-neutral-500 italic">Unavailable</span>
                          <% } %>
                    </td>

                  </tr>

                  <!-- WebSocket Status Logic (UNCHANGED) -->
                  <script>
                    (function () {
                      const id = "<%= server.id %>";
                      const dot = document.getElementById(`status-dot-${id}`);
                      const text = document.getElementById(`status-text-${id}`);
                      const uptimeEl = document.getElementById(`uptime-${id}`);

              <% if (!server.suspended) { %>
                const protocol = location.protocol === "https:" ? "wss" : "ws";
                        const ws = new WebSocket(`${protocol}://${location.host}/stats/${id}`);

                        let uptime = 0;

                        ws.onmessage = (e) => {
                          try {
                            const data = JSON.parse(e.data);
                            if (data.uptimeSeconds) uptime = data.uptimeSeconds;

                            if ((data.stats?.memory_stats?.usage || 0) > 1) {
                              dot.className =
                                "h-2.5 w-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]";
                              text.textContent = "Online";
                              text.className = "text-xs text-emerald-400";
                            } else {
                              dot.className = "h-2.5 w-2.5 rounded-full bg-red-500";
                              text.textContent = "Offline";
                              text.className = "text-xs text-red-400";
                            }
                          } catch { }
                        };

                        setInterval(() => {
                          if (dot.classList.contains("bg-emerald-500")) {
                            uptime++;
                            const h = Math.floor(uptime / 3600);
                            const m = Math.floor((uptime % 3600) / 60);
                            const s = uptime % 60;
                            uptimeEl.textContent = `${h}h ${m}m ${s}s`;
                          } else {
                            uptimeEl.textContent = "Offline";
                          }
                        }, 1000);
              <% } %>
            })();
                  </script>

                  <% }) %>
                    <% } else { %>
                      <tr>
                        <td colspan="5" class="px-6 py-24 text-center">
                          <div class="flex flex-col items-center justify-center">
                            <div class="mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-neutral-900">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                class="h-6 w-6 text-neutral-500">
                                <rect width="20" height="8" x="2" y="2" rx="2" ry="2" />
                                <rect width="20" height="8" x="2" y="14" rx="2" ry="2" />
                              </svg>
                            </div>
                            <h3 class="text-sm font-bold text-white">No Servers Found</h3>
                            <p class="mt-1 text-xs text-neutral-500">You donâ€™t have any servers yet.</p>
                          </div>
                        </td>
                      </tr>
                      <% } %>
            </tbody>
          </table>
        </div>


      </div>
    </main>

</body>

</html>
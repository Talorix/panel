<!DOCTYPE html>
<html lang="en" class="h-full bg-black text-white font-space-grotesk antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= name %> - New Image
  </title>
  <link rel="stylesheet" href="/assets/tailwind.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    .font-space-grotesk {
      font-family: 'Space Grotesk', sans-serif;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #000;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="flex h-full w-full overflow-hidden">

  <%- include('../../components/sidebar', { name, user }) %>

    <main class="relative flex-1 overflow-y-auto bg-black">
      <div class="mx-auto max-w-5xl px-6 py-12 md:px-12">

        <!-- Header -->
        <div class="mb-12">
          <h1 class="text-3xl font-bold tracking-tight text-white md:text-4xl">Create Image</h1>
          <p class="mt-2 text-neutral-400">Configure a new Docker image for your servers.</p>
        </div>

        <!-- Main Form Grid -->
        <div class="space-y-8">

          <!-- Basic Info -->
          <div class="rounded-md border border-neutral-900 bg-neutral-950 p-8">
            <h2 class="mb-6 text-lg font-bold text-white">Image Details</h2>
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
              <div class="space-y-2">
                <label class="text-xs font-bold uppercase tracking-wider text-neutral-500">Name</label>
                <input id="name" type="text" placeholder="e.g. NodeJS 18"
                  class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-3 text-sm text-white placeholder-neutral-600 outline-none focus:border-white focus:ring-1 focus:ring-white transition-all" />
              </div>
              <div class="space-y-2">
                <label class="text-xs font-bold uppercase tracking-wider text-neutral-500">Docker Image</label>
                <input id="dockerImage" type="text" placeholder="e.g. node:18-alpine"
                  class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-3 text-sm text-white placeholder-neutral-600 outline-none focus:border-white focus:ring-1 focus:ring-white transition-all font-mono" />
              </div>
              <div class="col-span-1 md:col-span-2 space-y-2">
                <label class="text-xs font-bold uppercase tracking-wider text-neutral-500">Description</label>
                <input id="description" type="text" placeholder="Optional description for this image..."
                  class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-3 text-sm text-white placeholder-neutral-600 outline-none focus:border-white focus:ring-1 focus:ring-white transition-all" />
              </div>
              <div class="space-y-2">
                <label class="text-xs font-bold uppercase tracking-wider text-neutral-500">Startup Command</label>
                <input id="startCmd" type="text" placeholder="node index.js" required
                  class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-3 text-sm text-white placeholder-neutral-600 outline-none focus:border-white focus:ring-1 focus:ring-white transition-all font-mono" />
              </div>
              <div class="space-y-2">
                <label class="text-xs font-bold uppercase tracking-wider text-neutral-500">Stop Command</label>
                <input id="stopCmd" type="text" placeholder="stop" required
                  class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-3 text-sm text-white placeholder-neutral-600 outline-none focus:border-white focus:ring-1 focus:ring-white transition-all font-mono" />
              </div>
            </div>
          </div>

          <!-- Configuration Cards -->
          <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
            <div class="flex flex-col rounded-md border border-neutral-900 bg-neutral-950 p-6">
                <div class="mb-6 flex items-center justify-between">
                <h2 class="text-lg font-bold text-white">DockerImages</h2>
                <button onclick="addDockerImage()"
                  class="flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-1.5 text-xs font-bold text-white hover:bg-neutral-800 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                  </svg>
                  Add Docker Image
                </button>
              </div>
              <div id="dockerImagesContainer" class="flex-1 space-y-3">
              </div>
              <p class="mt-4 text-center text-xs text-neutral-500 italic" id="dockerImageEmptyState">No docker images added.</p>
            </div>
            <!-- ENV VARS -->
            <div class="flex flex-col rounded-md border border-neutral-900 bg-neutral-950 p-6">
              <div class="mb-6 flex items-center justify-between">
                <h2 class="text-lg font-bold text-white">Environment Variables</h2>
                <button onclick="addEnv()"
                  class="flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-1.5 text-xs font-bold text-white hover:bg-neutral-800 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                  </svg>
                  Add Variable
                </button>
              </div>
              <div id="envsContainer" class="flex-1 space-y-3">
                <!-- Dynamic Items -->
              </div>
              <p class="mt-4 text-center text-xs text-neutral-500 italic" id="envEmptyState">No environment variables
                added.</p>
            </div>

            <!-- FEATURES -->
            <div class="flex flex-col rounded-md border border-neutral-900 bg-neutral-950 p-6">
              <div class="mb-6 flex items-center justify-between">
                <h2 class="text-lg font-bold text-white">Features</h2>
                <button onclick="addFeature()"
                  class="flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-1.5 text-xs font-bold text-white hover:bg-neutral-800 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                  </svg>
                  Add Feature
                </button>
              </div>
              <div id="featuresContainer" class="flex-1 space-y-3">
                <!-- Dynamic Items -->
              </div>
              <p class="mt-4 text-center text-xs text-neutral-500 italic" id="featEmptyState">No features added.</p>
            </div>

          </div>

          <!-- FILES -->
          <div class="rounded-md border border-neutral-900 bg-neutral-950 p-6">
            <div class="mb-6 flex items-center justify-between">
              <h2 class="text-lg font-bold text-white">Startup Files/Scripts</h2>
              <button onclick="addFile()"
                class="flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-1.5 text-xs font-bold text-white hover:bg-neutral-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="h-4 w-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Add File
              </button>
            </div>
            <div id="filesContainer" class="space-y-3">
              <!-- Dynamic Items -->
            </div>
            <p class="mt-4 text-center text-xs text-neutral-500 italic" id="fileEmptyState">No files added.</p>
          </div>
          
          <!-- Action Bar -->
          <div class="flex items-center justify-end gap-4 pt-4 border-t border-neutral-900">
            <a href="/admin/images"
              class="rounded-xl px-6 py-3 text-sm font-bold text-neutral-400 hover:text-white transition-colors">Cancel</a>
            <button onclick="createImage()"
              class="rounded-xl bg-white px-8 py-3 text-sm font-bold text-black transition-transform hover:scale-[1.02] hover:bg-neutral-200 shadow-lg shadow-white/10">
              Create Image
            </button>
          </div>

        </div>
      </div>
    </main>

    <script>
      const envContainer = document.getElementById("envsContainer");
      const featContainer = document.getElementById("featuresContainer");
      const fileContainer = document.getElementById("filesContainer");
      const envEmpty = document.getElementById("envEmptyState");
      const featEmpty = document.getElementById("featEmptyState");
      const fileEmpty = document.getElementById("fileEmptyState");

      function updateEmptyStates() {
        envEmpty.style.display = envContainer.children.length ? 'none' : 'block';
        featEmpty.style.display = featContainer.children.length ? 'none' : 'block';
        fileEmpty.style.display = fileContainer.children.length ? 'none' : 'block';
      }

      function addEnv() {
        const div = document.createElement("div");
        div.className = "flex items-center gap-3 animate-slide-up";
        div.innerHTML = `
           <div class="flex-1 grid grid-cols-2 gap-3">
               <input placeholder="Key" class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-white placeholder-neutral-600 outline-none focus:border-white transition-all" />
               <input placeholder="Default Value" class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-white placeholder-neutral-600 outline-none focus:border-white transition-all" />
           </div>
           <button onclick="this.closest('div.flex').remove(); updateEmptyStates();" class="shrink-0 p-2 text-neutral-500 hover:text-red-500 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
           </button>
        `;
        envContainer.appendChild(div);
        updateEmptyStates();
      }

      function addFeature() {
        const div = document.createElement("div");
        div.className = "flex items-center gap-3 animate-slide-up";
        div.innerHTML = `
           <input placeholder="Feature Code (e.g. eula, java_version)" class="flex-1 rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-white placeholder-neutral-600 outline-none focus:border-white transition-all" />
           <button onclick="this.closest('div.flex').remove(); updateEmptyStates();" class="shrink-0 p-2 text-neutral-500 hover:text-red-500 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
           </button>
        `;
        featContainer.appendChild(div);
        updateEmptyStates();
      }
      function addDockerImage() {
        const div = document.createElement("div");
        div.className = "flex items-center gap-3 animate-slide-up";
        div.innerHTML = `
           <input placeholder="Docker Image (e.g. node:18-alpine)" class="flex-1 rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-white placeholder-neutral-600 outline-none focus:border-white transition-all font-mono" />
           <button onclick="this.closest('div.flex').remove(); updateEmptyStates();" class="shrink-0 p-2 text-neutral-500 hover:text-red-500 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
           </button>
        `;
        document.getElementById("dockerImagesContainer").appendChild(div);
        updateEmptyStates();
      }
      function addFile() {
        const div = document.createElement("div");
        div.className = "flex items-center gap-3 animate-slide-up";
        div.innerHTML = `
           <div class="flex-1 grid grid-cols-2 gap-3">
               <input placeholder="Filename" class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-white placeholder-neutral-600 outline-none focus:border-white transition-all" />
               <input placeholder="Download URL" class="w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-white placeholder-neutral-600 outline-none focus:border-white transition-all" />
           </div>
           <button onclick="this.closest('div.flex').remove(); updateEmptyStates();" class="shrink-0 p-2 text-neutral-500 hover:text-red-500 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
           </button>
        `;
        fileContainer.appendChild(div);
        updateEmptyStates();
      }

      async function createImage() {
        const name = document.getElementById("name").value.trim();
        const dockerImage = document.getElementById("dockerImage").value.trim();
        const description = document.getElementById("description").value.trim();

        if (!name || !dockerImage) return alert("Name and Docker Image are required.");

        const envs = {};
        envContainer.querySelectorAll("div.grid").forEach(row => {
          const inputs = row.querySelectorAll("input");
          const key = inputs[0].value.trim();
          const val = inputs[1].value.trim();
          if (key) envs[key] = val;
        });

        const files = [];
        fileContainer.querySelectorAll("div.grid").forEach(row => {
          const inputs = row.querySelectorAll("input");
          const name = inputs[0].value.trim();
          const url = inputs[1].value.trim();
          if (name && url) files.push({ filename: name, url });
        });

        const features = [];
        featContainer.querySelectorAll("input").forEach(input => {
          if (input.value.trim()) features.push(input.value.trim());
        });

        try {
          const res = await axios.post('/admin/images/new', { dockerImage, name, description, envs, files, features });
          if (res.data.success) window.location.href = '/admin/images';
          else alert("Failed to create image.");
        } catch (e) {
          alert("Error: " + (e.response?.data?.message || e.message));
        }
      }
    </script>
</body>

</html>